<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¯¸êµ­ ì¬ë¬´ë¶€ TGA vs S&P 500</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0d1117;
      --surface: #161b22;
      --border:  #21262d;
      --text:    #c9d1d9;
      --muted:   #8b949e;
      --gold:    #FFD700;
      --green:   #00E676;
      --blue:    #40C4FF;
      --red:     #FF5252;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.8rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left h1 { font-size: 1.1rem; font-weight: 700; color: #e6edf3; }
    .header-left p  { font-size: 0.8rem; color: var(--muted); margin-top: 0.2rem; }

    .badge-row { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .badge {
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 600;
    }
    .badge-gold  { background: #2d200066; color: var(--gold);  border: 1px solid #FFD70044; }
    .badge-green { background: #00260f66; color: var(--green); border: 1px solid #00E67644; }
    .badge-blue  { background: #001a2e66; color: var(--blue);  border: 1px solid #40C4FF44; }
    .badge-red   { background: #2e000066; color: var(--red);   border: 1px solid #FF525244; }

    /* â”€â”€ Range controls â”€â”€ */
    .range-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.7rem 2rem;
      display: flex;
      align-items: center;
      gap: 1.2rem;
      flex-wrap: wrap;
    }

    .range-bar label { font-size: 0.8rem; color: var(--muted); white-space: nowrap; }

    .btn-group { display: flex; gap: 0.3rem; }
    .rng-btn {
      padding: 0.3rem 0.65rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all .15s;
    }
    .rng-btn:hover  { border-color: var(--blue); color: var(--blue); }
    .rng-btn.active { border-color: var(--blue); background: #001a2e; color: var(--blue); font-weight: 700; }

    .date-inputs { display: flex; align-items: center; gap: 0.4rem; }
    .date-inputs input[type="date"] {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 0.28rem 0.5rem;
      font-size: 0.8rem;
    }
    .date-inputs span { color: var(--muted); font-size: 0.8rem; }

    .apply-btn {
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      border: 1px solid var(--blue);
      background: #001a2e;
      color: var(--blue);
      font-size: 0.78rem;
      cursor: pointer;
      font-weight: 600;
    }
    .apply-btn:hover { background: #003060; }

    /* â”€â”€ Stat cards â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      padding: 1.2rem 2rem;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.9rem 1.1rem;
    }
    .stat-card .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
    .stat-card .value { font-size: 1.25rem; font-weight: 700; color: #e6edf3; margin-top: 0.3rem; }
    .stat-card .sub   { font-size: 0.75rem; color: var(--muted); margin-top: 0.15rem; }

    /* â”€â”€ Charts â”€â”€ */
    main { padding: 0 2rem 2rem; }

    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.5rem;
      margin-bottom: 1.2rem;
      overflow: hidden;
    }

    .chart-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      padding: 0.6rem 0.8rem 0;
      letter-spacing: 0.03em;
    }

    .plotly-chart { width: 100%; }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      border-top: 1px solid var(--border);
      padding: 1rem 2rem;
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    footer a { color: var(--blue); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* â”€â”€ Loading â”€â”€ */
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 60vh;
      flex-direction: column;
      gap: 1rem;
      color: var(--muted);
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #app { display: none; }
  </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <span>ë°ì´í„° ë¡œë”© ì¤‘â€¦</span>
</div>

<!-- App -->
<div id="app">

  <header>
    <div class="header-left">
      <h1>ğŸ¦ ë¯¸êµ­ ì¬ë¬´ë¶€ TGA ì”ê³  &amp; S&amp;P 500 ìƒê´€ê´€ê³„</h1>
      <p>ìµœì¢… ì—…ë°ì´íŠ¸: <span id="updated-date">â€”</span> &nbsp;Â·&nbsp; ë§¤ ì˜ì—…ì¼ ìë™ ê°±ì‹ </p>
    </div>
    <div class="badge-row">
      <span class="badge badge-gold">TGA Balance</span>
      <span class="badge badge-green">S&amp;P 500</span>
      <span class="badge badge-blue">Pearson r</span>
      <span class="badge badge-red">Rolling Corr</span>
    </div>
  </header>

  <!-- Range controls -->
  <div class="range-bar">
    <label>ê¸°ê°„ ì„ íƒ</label>
    <div class="btn-group" id="range-btns">
      <button class="rng-btn" data-months="3">3M</button>
      <button class="rng-btn" data-months="6">6M</button>
      <button class="rng-btn" data-months="12">1Y</button>
      <button class="rng-btn active" data-months="0">ì „ì²´</button>
    </div>
    <div class="date-inputs">
      <input type="date" id="date-from" />
      <span>~</span>
      <input type="date" id="date-to" />
      <button class="apply-btn" id="apply-range">ì ìš©</button>
    </div>
  </div>

  <!-- Stat cards -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="label">TGA í˜„ì¬ ì”ê³ </div>
      <div class="value" id="stat-tga">â€”</div>
      <div class="sub">ì‹­ì–µ ë‹¬ëŸ¬ (B$)</div>
    </div>
    <div class="stat-card">
      <div class="label">S&amp;P 500 í˜„ì¬</div>
      <div class="value" id="stat-sp500">â€”</div>
      <div class="sub">ìµœì‹  ì¢…ê°€</div>
    </div>
    <div class="stat-card">
      <div class="label">ì „ì²´ Pearson r</div>
      <div class="value" id="stat-corr">â€”</div>
      <div class="sub" id="stat-pval">â€”</div>
    </div>
    <div class="stat-card">
      <div class="label">ì„ íƒ êµ¬ê°„ r</div>
      <div class="value" id="stat-range-corr">â€”</div>
      <div class="sub">í˜„ì¬ ì„ íƒ êµ¬ê°„ ê¸°ì¤€</div>
    </div>
    <div class="stat-card">
      <div class="label">ë°ì´í„° ì‹œì‘ì¼</div>
      <div class="value" id="stat-start">â€”</div>
      <div class="sub">TGA ë°ì´í„° ì œê³µ ì‹œì‘</div>
    </div>
  </div>

  <main>
    <!-- Chart 1: Dual axis -->
    <div class="chart-card">
      <div class="chart-title">S&amp;P 500 &amp; TGA ì”ê³  â€” ì‹œê³„ì—´</div>
      <div id="chart-main" class="plotly-chart"></div>
    </div>

    <!-- Chart 2: Rolling correlation -->
    <div class="chart-card">
      <div class="chart-title">6ê°œì›” ë¡¤ë§ ìƒê´€ê³„ìˆ˜ (Pearson r)</div>
      <div id="chart-corr" class="plotly-chart"></div>
    </div>

    <!-- Chart 3: Scatter -->
    <div class="chart-card">
      <div class="chart-title">TGA ì”ê³  vs S&amp;P 500 â€” ì‚°ì ë„ (ì„ íƒ êµ¬ê°„)</div>
      <div id="chart-scatter" class="plotly-chart"></div>
    </div>
  </main>

  <footer>
    <span>
      ë°ì´í„°:
      <a href="https://fiscaldata.treasury.gov" target="_blank">US Treasury Fiscal Data</a>
      &amp;
      <a href="https://finance.yahoo.com" target="_blank">Yahoo Finance</a>
    </span>
    <span>
      ì†ŒìŠ¤ ì½”ë“œ:
      <a href="https://github.com/SangbumChoi/finance" target="_blank">github.com/SangbumChoi/finance</a>
    </span>
  </footer>

</div><!-- /#app -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê³µí†µ Plotly ì„¤ì •
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BG      = '#0d1117';
const SURFACE = '#161b22';
const GOLD    = '#FFD700';
const GREEN   = '#00E676';
const BLUE    = '#40C4FF';
const RED     = '#FF5252';
const GRAY    = '#90A4AE';

const baseLayout = {
  paper_bgcolor: SURFACE,
  plot_bgcolor:  BG,
  font: { color: GRAY, family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif', size: 12 },
  margin: { l: 60, r: 60, t: 16, b: 40 },
  xaxis: {
    gridcolor: '#1e2933', showgrid: true,
    linecolor: '#263238', tickcolor: GRAY,
    rangeslider: { visible: false },
  },
  yaxis: { gridcolor: '#1e2933', showgrid: true, linecolor: '#263238', tickcolor: GRAY },
  legend: {
    bgcolor: '#1a1a2e88', bordercolor: '#21262d',
    borderwidth: 1, font: { color: '#e6edf3' },
  },
  hovermode: 'x unified',
  hoverlabel: { bgcolor: '#1a1a2e', bordercolor: '#21262d', font: { color: '#e6edf3' } },
};

const config = { responsive: true, displayModeBar: true, displaylogo: false,
  modeBarButtonsToRemove: ['lasso2d', 'select2d'] };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìƒíƒœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let RAW = null;   // ì „ì²´ ë°ì´í„°
let rangeFrom = null;
let rangeTo   = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í—¬í¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n, decimals = 0) {
  if (n == null) return 'â€”';
  return n.toLocaleString('ko-KR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function pearsonR(xs, ys) {
  const n = xs.length;
  if (n < 2) return NaN;
  const mx = xs.reduce((a, b) => a + b, 0) / n;
  const my = ys.reduce((a, b) => a + b, 0) / n;
  let num = 0, dx2 = 0, dy2 = 0;
  for (let i = 0; i < n; i++) {
    const dx = xs[i] - mx, dy = ys[i] - my;
    num += dx * dy; dx2 += dx * dx; dy2 += dy * dy;
  }
  return num / Math.sqrt(dx2 * dy2);
}

// í˜„ì¬ rangeFrom/rangeTo ê¸°ì¤€ ì¸ë±ìŠ¤ ë²”ìœ„ ë°˜í™˜
function sliceByRange() {
  const dates = RAW.dates;
  let i0 = 0, i1 = dates.length - 1;
  if (rangeFrom) { while (i0 < dates.length && dates[i0] < rangeFrom) i0++; }
  if (rangeTo)   { while (i1 > 0           && dates[i1] > rangeTo)   i1--; }
  return [i0, i1];
}

function getSlice() {
  const [i0, i1] = sliceByRange();
  return {
    dates:        RAW.dates.slice(i0, i1 + 1),
    tga:          RAW.tga.slice(i0, i1 + 1),
    sp500:        RAW.sp500.slice(i0, i1 + 1),
    rolling_corr: RAW.rolling_corr.slice(i0, i1 + 1),
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì°¨íŠ¸ 1 â€” ì´ì¤‘ ì¶• ì‹œê³„ì—´
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMain(slice) {
  const traces = [
    {
      x: slice.dates, y: slice.sp500,
      name: 'S&P 500', type: 'scatter', mode: 'lines',
      line: { color: GREEN, width: 1.8 },
      yaxis: 'y',
      hovertemplate: '<b>S&P 500</b>: %{y:,.0f}<extra></extra>',
    },
    {
      x: slice.dates, y: slice.tga,
      name: 'TGA ì”ê³  (B$)', type: 'scatter', mode: 'lines',
      line: { color: GOLD, width: 1.5 },
      fill: 'tozeroy', fillcolor: GOLD + '22',
      yaxis: 'y2',
      hovertemplate: '<b>TGA</b>: $%{y:,.1f}B<extra></extra>',
    },
  ];

  const layout = {
    ...baseLayout,
    margin: { l: 70, r: 70, t: 16, b: 40 },
    height: 380,
    yaxis: {
      ...baseLayout.yaxis,
      title: { text: 'S&P 500', font: { color: GREEN } },
      tickformat: ',.0f', tickfont: { color: GREEN },
    },
    yaxis2: {
      gridcolor: '#1e2933', showgrid: false, linecolor: '#263238',
      title: { text: 'TGA ì”ê³  (B$)', font: { color: GOLD } },
      tickformat: '$,.0f', tickfont: { color: GOLD },
      overlaying: 'y', side: 'right',
    },
    xaxis: {
      ...baseLayout.xaxis,
      rangeslider: { visible: true, bgcolor: '#1e2933', bordercolor: '#21262d', thickness: 0.06 },
      rangeselector: {
        bgcolor: SURFACE, bordercolor: '#21262d', borderwidth: 1,
        font: { color: GRAY },
        buttons: [
          { count: 3,  step: 'month', stepmode: 'backward', label: '3M' },
          { count: 6,  step: 'month', stepmode: 'backward', label: '6M' },
          { count: 1,  step: 'year',  stepmode: 'backward', label: '1Y' },
          { count: 2,  step: 'year',  stepmode: 'backward', label: '2Y' },
          { step: 'all', label: 'ì „ì²´' },
        ],
      },
    },
  };

  Plotly.react('chart-main', traces, layout, config);

  // rangeslider ë³€ê²½ â†’ ë‹¤ë¥¸ ì°¨íŠ¸ ë™ê¸°í™”
  document.getElementById('chart-main').on('plotly_relayout', (e) => {
    const from = e['xaxis.range[0]'] || (e['xaxis.range'] && e['xaxis.range'][0]);
    const to   = e['xaxis.range[1]'] || (e['xaxis.range'] && e['xaxis.range'][1]);
    if (from && to) {
      rangeFrom = from.substring(0, 10);
      rangeTo   = to.substring(0, 10);
      document.getElementById('date-from').value = rangeFrom;
      document.getElementById('date-to').value   = rangeTo;
      syncCharts();
    }
    if (e['xaxis.autorange']) {
      rangeFrom = RAW.dates[0];
      rangeTo   = RAW.dates[RAW.dates.length - 1];
      document.getElementById('date-from').value = rangeFrom;
      document.getElementById('date-to').value   = rangeTo;
      syncCharts();
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì°¨íŠ¸ 2 â€” ë¡¤ë§ ìƒê´€ê³„ìˆ˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCorr(slice) {
  const colors = slice.rolling_corr.map(v => (v == null ? GRAY : v >= 0 ? GREEN : RED));

  const traces = [
    {
      x: slice.dates, y: slice.rolling_corr,
      name: '6ê°œì›” ë¡¤ë§ r', type: 'bar',
      marker: { color: colors, opacity: 0.75 },
      hovertemplate: '<b>ë¡¤ë§ r</b>: %{y:.3f}<extra></extra>',
    },
    {
      x: [slice.dates[0], slice.dates[slice.dates.length - 1]],
      y: [RAW.corr, RAW.corr],
      name: `ì „ì²´ r = ${RAW.corr}`,
      type: 'scatter', mode: 'lines',
      line: { color: BLUE, width: 1.5, dash: 'dash' },
      hoverinfo: 'skip',
    },
    {
      x: [slice.dates[0], slice.dates[slice.dates.length - 1]],
      y: [0, 0],
      name: '', showlegend: false,
      type: 'scatter', mode: 'lines',
      line: { color: GRAY, width: 0.8 },
      hoverinfo: 'skip',
    },
  ];

  const layout = {
    ...baseLayout,
    height: 240,
    bargap: 0.1,
    yaxis: {
      ...baseLayout.yaxis,
      range: [-1.05, 1.05],
      tickformat: '.2f',
      title: { text: 'Pearson r', font: { color: GRAY } },
      zeroline: false,
    },
    xaxis: { ...baseLayout.xaxis,
      range: [rangeFrom || RAW.dates[0], rangeTo || RAW.dates[RAW.dates.length - 1]] },
  };

  Plotly.react('chart-corr', traces, layout, config);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì°¨íŠ¸ 3 â€” ì‚°ì ë„ (êµ¬ê°„ ë°˜ì‘)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawScatter(slice) {
  // ì—°ë„ë³„ ìƒ‰ìƒ
  const years = [...new Set(slice.dates.map(d => d.substring(0, 4)))].sort();
  const palette = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#845EC2','#FF9671','#00C9A7'];
  const yearColor = {};
  years.forEach((y, i) => yearColor[y] = palette[i % palette.length]);

  const byYear = {};
  slice.dates.forEach((d, i) => {
    const y = d.substring(0, 4);
    if (!byYear[y]) byYear[y] = { x: [], y: [] };
    if (slice.tga[i] != null && slice.sp500[i] != null) {
      byYear[y].x.push(slice.tga[i]);
      byYear[y].y.push(slice.sp500[i]);
    }
  });

  // ì„ íƒ êµ¬ê°„ ìƒê´€ê³„ìˆ˜ ê³„ì‚°
  const allX = [], allY = [];
  Object.values(byYear).forEach(g => { allX.push(...g.x); allY.push(...g.y); });
  const r = pearsonR(allX, allY);
  document.getElementById('stat-range-corr').textContent = isNaN(r) ? 'â€”' : r.toFixed(3);

  // ì¶”ì„¸ì„ 
  const n = allX.length;
  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
  for (let i = 0; i < n; i++) {
    sumX += allX[i]; sumY += allY[i];
    sumXY += allX[i] * allY[i]; sumX2 += allX[i] * allX[i];
  }
  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  const xMin = Math.min(...allX), xMax = Math.max(...allX);
  const trendX = [xMin, xMax];
  const trendY = trendX.map(x => slope * x + intercept);

  const traces = Object.entries(byYear).map(([y, g]) => ({
    x: g.x, y: g.y,
    name: y, type: 'scatter', mode: 'markers',
    marker: { color: yearColor[y], size: 5, opacity: 0.65 },
    hovertemplate: `<b>${y}</b><br>TGA: $%{x:,.1f}B<br>S&P: %{y:,.0f}<extra></extra>`,
  }));

  traces.push({
    x: trendX, y: trendY,
    name: `ì¶”ì„¸ì„  r=${isNaN(r) ? 'â€”' : r.toFixed(3)}`,
    type: 'scatter', mode: 'lines',
    line: { color: BLUE, width: 2, dash: 'dash' },
    hoverinfo: 'skip',
  });

  const layout = {
    ...baseLayout,
    height: 320,
    xaxis: {
      ...baseLayout.xaxis,
      rangeslider: { visible: false },
      title: { text: 'TGA ì”ê³  (B$)', font: { color: GRAY } },
      tickprefix: '$', ticksuffix: 'B',
    },
    yaxis: {
      ...baseLayout.yaxis,
      title: { text: 'S&P 500', font: { color: GRAY } },
      tickformat: ',.0f',
    },
  };

  Plotly.react('chart-scatter', traces, layout, config);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const last = RAW.dates.length - 1;
  document.getElementById('stat-tga').textContent   = `$${fmt(RAW.tga[last], 1)}B`;
  document.getElementById('stat-sp500').textContent = fmt(RAW.sp500[last], 0);
  document.getElementById('stat-corr').textContent  = RAW.corr;
  document.getElementById('stat-pval').textContent  = `p ${RAW.pval < 0.001 ? '< 0.001' : '= ' + RAW.pval}`;
  document.getElementById('stat-start').textContent = RAW.dates[0];
  document.getElementById('updated-date').textContent = RAW.updated;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë™ê¸°í™” (êµ¬ê°„ ë³€ê²½ ì‹œ corr + scatter ì¬ë Œë”)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncCharts() {
  const slice = getSlice();
  drawCorr(slice);
  drawScatter(slice);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë²”ìœ„ ë²„íŠ¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyMonths(months) {
  const lastDate = new Date(RAW.dates[RAW.dates.length - 1]);
  if (months === 0) {
    rangeFrom = RAW.dates[0];
    rangeTo   = RAW.dates[RAW.dates.length - 1];
  } else {
    const from = new Date(lastDate);
    from.setMonth(from.getMonth() - months);
    rangeFrom = from.toISOString().substring(0, 10);
    rangeTo   = RAW.dates[RAW.dates.length - 1];
  }
  document.getElementById('date-from').value = rangeFrom;
  document.getElementById('date-to').value   = rangeTo;

  Plotly.relayout('chart-main', { 'xaxis.range': [rangeFrom, rangeTo] });
  syncCharts();
}

document.getElementById('range-btns').addEventListener('click', (e) => {
  const btn = e.target.closest('.rng-btn');
  if (!btn) return;
  document.querySelectorAll('.rng-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyMonths(Number(btn.dataset.months));
});

document.getElementById('apply-range').addEventListener('click', () => {
  rangeFrom = document.getElementById('date-from').value;
  rangeTo   = document.getElementById('date-to').value;
  if (!rangeFrom || !rangeTo) return;
  document.querySelectorAll('.rng-btn').forEach(b => b.classList.remove('active'));
  Plotly.relayout('chart-main', { 'xaxis.range': [rangeFrom, rangeTo] });
  syncCharts();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const res = await fetch('data.json');
  RAW = await res.json();

  rangeFrom = RAW.dates[0];
  rangeTo   = RAW.dates[RAW.dates.length - 1];
  document.getElementById('date-from').value = rangeFrom;
  document.getElementById('date-to').value   = rangeTo;

  updateStats();

  const slice = getSlice();
  drawMain(slice);
  drawCorr(slice);
  drawScatter(slice);

  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
}

init().catch(err => {
  document.getElementById('loading').innerHTML =
    `<span style="color:var(--red)">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</span>`;
});
</script>
</body>
</html>
