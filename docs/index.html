<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Macro Analytics</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --sidebar-w: 220px;
      --bg:      #0d1117;
      --surface: #161b22;
      --surface2:#1c2128;
      --border:  #21262d;
      --text:    #c9d1d9;
      --muted:   #8b949e;
      --gold:    #FFD700;
      --green:   #00E676;
      --blue:    #40C4FF;
      --red:     #FF5252;
      --orange:  #FF9800;
    }
    html { scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; min-height: 100vh; }

    /* â”€â”€ Layout â”€â”€ */
    .layout { display: flex; min-height: 100vh; }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      width: var(--sidebar-w);
      min-height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      overflow-y: auto;
      z-index: 200;
      transition: transform .25s ease;
    }
    .sidebar.collapsed { transform: translateX(calc(-1 * var(--sidebar-w))); }

    .sidebar-header {
      padding: 1rem 0.9rem 0.8rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sidebar-logo { font-size: 1.3rem; }
    .sidebar-brand { font-size: 0.88rem; font-weight: 700; color: #e6edf3; flex: 1; }

    .nav-section {
      padding: 1rem 0.6rem 0.4rem;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      width: 100%;
      padding: 0.55rem 0.9rem;
      margin: 0.1rem 0.4rem;
      width: calc(100% - 0.8rem);
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--muted);
      font-size: 0.83rem;
      cursor: pointer;
      text-align: left;
      transition: all .15s;
    }
    .nav-item:hover  { background: var(--surface2); color: var(--text); }
    .nav-item.active { background: #001a2e; color: var(--blue); font-weight: 600; }
    .nav-icon { font-size: 1rem; flex-shrink: 0; }

    .sidebar-footer {
      margin-top: auto;
      padding: 0.8rem;
      border-top: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--muted);
      text-align: center;
    }

    /* â”€â”€ Main â”€â”€ */
    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: margin-left .25s ease;
    }
    .main.full { margin-left: 0; }

    /* â”€â”€ Top Header â”€â”€ */
    .top-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.6rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left { display: flex; align-items: center; gap: 0.8rem; }

    .sidebar-toggle-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 6px;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      transition: all .15s;
    }
    .sidebar-toggle-btn:hover { border-color: var(--blue); color: var(--blue); }

    .header-title h1 { font-size: 1rem; font-weight: 700; color: #e6edf3; }
    .header-title p  { font-size: 0.75rem; color: var(--muted); }

    .header-right { display: flex; align-items: center; gap: 0.8rem; }

    /* â”€â”€ Language switcher â”€â”€ */
    .lang-switcher {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .lang-btn {
      padding: 0.28rem 0.55rem;
      border: none;
      border-right: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }
    .lang-btn:last-child { border-right: none; }
    .lang-btn:hover      { background: var(--surface2); color: var(--text); }
    .lang-btn.active     { background: #001a2e; color: var(--blue); font-weight: 700; }

    /* â”€â”€ Range bar â”€â”€ */
    .range-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.55rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .range-label { font-size: 0.78rem; color: var(--muted); }

    .btn-group { display: flex; gap: 0.25rem; }
    .rng-btn {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 0.76rem;
      cursor: pointer;
      transition: all .15s;
    }
    .rng-btn:hover  { border-color: var(--blue); color: var(--blue); }
    .rng-btn.active { border-color: var(--blue); background: #001a2e; color: var(--blue); font-weight: 700; }

    .date-inputs { display: flex; align-items: center; gap: 0.35rem; }
    .date-inputs input[type="date"] {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text); border-radius: 6px;
      padding: 0.25rem 0.45rem; font-size: 0.76rem;
    }
    .date-inputs span { color: var(--muted); font-size: 0.78rem; }
    .apply-btn {
      padding: 0.25rem 0.7rem; border-radius: 6px;
      border: 1px solid var(--blue); background: #001a2e;
      color: var(--blue); font-size: 0.76rem; cursor: pointer; font-weight: 600;
    }
    .apply-btn:hover { background: #003060; }

    /* â”€â”€ Stats â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8rem;
      padding: 1rem 1.5rem;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.8rem 1rem;
    }
    .stat-card .label { font-size: 0.69rem; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
    .stat-card .value { font-size: 1.15rem; font-weight: 700; color: #e6edf3; margin-top: 0.25rem; }
    .stat-card .sub   { font-size: 0.72rem; color: var(--muted); margin-top: 0.12rem; }

    /* â”€â”€ Charts â”€â”€ */
    .charts { padding: 0 1.5rem 1.5rem; }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.4rem;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .chart-title {
      font-size: 0.8rem; font-weight: 600;
      color: var(--muted); padding: 0.5rem 0.7rem 0;
      letter-spacing: .03em;
    }

    /* â”€â”€ Footer â”€â”€ */
    footer {
      margin-top: auto;
      border-top: 1px solid var(--border);
      padding: 0.8rem 1.5rem;
      font-size: 0.76rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    footer a { color: var(--blue); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* â”€â”€ Loading / overlay â”€â”€ */
    #loading {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 1rem; color: var(--muted);
      z-index: 9999;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Mobile â”€â”€ */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(calc(-1 * var(--sidebar-w))); }
      .sidebar.open { transform: translateX(0); box-shadow: 4px 0 20px #0006; }
      .main { margin-left: 0; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .range-bar { padding: 0.55rem 1rem; }
      .charts { padding: 0 1rem 1rem; }
    }

    /* Sidebar overlay on mobile */
    .sidebar-overlay {
      display: none;
      position: fixed; inset: 0;
      background: #0008;
      z-index: 199;
    }
    .sidebar-overlay.show { display: block; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><span id="loading-text">ë¡œë”© ì¤‘â€¦</span></div>
<div class="sidebar-overlay" id="overlay"></div>

<div class="layout">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-logo">ğŸ“Š</span>
      <span class="sidebar-brand" data-i18n="sidebarTitle">ë§¤í¬ë¡œ ë¶„ì„</span>
    </div>

    <div class="nav-section" data-i18n="navSection">ì‹œì¥ ì§€í‘œ</div>

    <button class="nav-item active" data-view="tga">
      <span class="nav-icon">ğŸ¦</span>
      <span data-i18n="navTga">TGA vs S&amp;P 500</span>
    </button>
    <button class="nav-item" data-view="fed">
      <span class="nav-icon">ğŸ“ˆ</span>
      <span data-i18n="navFed">ê¸°ì¤€ê¸ˆë¦¬ vs S&amp;P 500</span>
    </button>

    <div class="sidebar-footer">
      <span data-i18n="sidebarFooter">ë§¤ ì˜ì—…ì¼ ìë™ ì—…ë°ì´íŠ¸</span>
    </div>
  </nav>

  <!-- â”€â”€ Main â”€â”€ -->
  <div class="main" id="main">

    <!-- Top Header -->
    <header class="top-header">
      <div class="header-left">
        <button class="sidebar-toggle-btn" id="sidebar-toggle" title="Toggle sidebar">â˜°</button>
        <div class="header-title">
          <h1 id="view-title">â€”</h1>
          <p id="view-sub">â€”</p>
        </div>
      </div>
      <div class="header-right">
        <!-- Language switcher -->
        <div class="lang-switcher">
          <button class="lang-btn active" data-lang="ko">í•œêµ­ì–´</button>
          <button class="lang-btn" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="zh">ä¸­æ–‡</button>
          <button class="lang-btn" data-lang="ja">æ—¥æœ¬èª</button>
        </div>
      </div>
    </header>

    <!-- Range bar -->
    <div class="range-bar">
      <span class="range-label" data-i18n="rangeLabel">ê¸°ê°„ ì„ íƒ</span>
      <div class="btn-group" id="range-btns">
        <button class="rng-btn" data-months="3">3M</button>
        <button class="rng-btn" data-months="6">6M</button>
        <button class="rng-btn" data-months="12">1Y</button>
        <button class="rng-btn" data-months="24">2Y</button>
        <button class="rng-btn active" data-months="0" data-i18n-inner="rangeAll">ì „ì²´</button>
      </div>
      <div class="date-inputs">
        <input type="date" id="date-from" />
        <span>~</span>
        <input type="date" id="date-to" />
        <button class="apply-btn" id="apply-range" data-i18n="rangeApply">ì ìš©</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="label" id="stat-x-label" data-i18n="statX">â€”</div>
        <div class="value" id="stat-x">â€”</div>
        <div class="sub" id="stat-x-sub">â€”</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="statSp500">S&amp;P 500</div>
        <div class="value" id="stat-sp500">â€”</div>
        <div class="sub" data-i18n="statSp500Sub">ìµœì‹  ì¢…ê°€</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="statCorr">ì „ì²´ Pearson r</div>
        <div class="value" id="stat-corr">â€”</div>
        <div class="sub" id="stat-pval">â€”</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="statRangeCorr">ì„ íƒ êµ¬ê°„ r</div>
        <div class="value" id="stat-range-corr">â€”</div>
        <div class="sub" data-i18n="statRangeCorrSub">í˜„ì¬ ì„ íƒ êµ¬ê°„</div>
      </div>
      <div class="stat-card">
        <div class="label" data-i18n="statUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
        <div class="value" id="stat-updated">â€”</div>
        <div class="sub" data-i18n="statUpdatedSub">ìë™ ê°±ì‹ </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-card">
        <div class="chart-title" id="title-main">â€”</div>
        <div id="chart-main"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title" id="title-corr" data-i18n="chartCorr">ë¡¤ë§ ìƒê´€ê³„ìˆ˜ (Pearson r)</div>
        <div id="chart-corr"></div>
      </div>
      <div class="chart-card">
        <div class="chart-title" id="title-scatter">â€”</div>
        <div id="chart-scatter"></div>
      </div>
    </div>

    <footer>
      <span>
        <span data-i18n="footerData">ë°ì´í„°</span>:
        <a href="https://fiscaldata.treasury.gov" target="_blank">US Treasury</a> &amp;
        <a href="https://fred.stlouisfed.org" target="_blank">FRED</a> &amp;
        <a href="https://finance.yahoo.com" target="_blank">Yahoo Finance</a>
      </span>
      <span>
        <span data-i18n="footerSource">ì†ŒìŠ¤ ì½”ë“œ</span>:
        <a href="https://github.com/SangbumChoi/finance" target="_blank">SangbumChoi/finance</a>
      </span>
    </footer>

  </div><!-- /.main -->
</div><!-- /.layout -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// i18n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = {
  ko: {
    sidebarTitle:'ë§¤í¬ë¡œ ë¶„ì„', navSection:'ì‹œì¥ ì§€í‘œ',
    navTga:'TGA vs S&P 500', navFed:'ê¸°ì¤€ê¸ˆë¦¬ vs S&P 500',
    sidebarFooter:'ë§¤ ì˜ì—…ì¼ ìë™ ì—…ë°ì´íŠ¸',
    viewTitleTga:'ë¯¸êµ­ ì¬ë¬´ë¶€ TGA ì”ê³  & S&P 500',
    viewSubTga:'ë§¤ ì˜ì—…ì¼ ìë™ ì—…ë°ì´íŠ¸ Â· US Treasury Fiscal Data',
    viewTitleFed:'ë¯¸êµ­ ê¸°ì¤€ê¸ˆë¦¬(FEDFUNDS) & S&P 500',
    viewSubFed:'ë§¤ì›” ì—…ë°ì´íŠ¸ Â· FRED (Federal Reserve Economic Data)',
    statX:'TGA í˜„ì¬ ì”ê³ ', statXSub:'ì‹­ì–µ ë‹¬ëŸ¬ (B$)',
    statXFed:'í˜„ì¬ ê¸°ì¤€ê¸ˆë¦¬', statXSubFed:'%',
    statSp500:'S&P 500', statSp500Sub:'ìµœì‹  ì¢…ê°€',
    statCorr:'ì „ì²´ Pearson r', statRangeCorr:'ì„ íƒ êµ¬ê°„ r',
    statRangeCorrSub:'í˜„ì¬ ì„ íƒ êµ¬ê°„', statUpdated:'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸', statUpdatedSub:'ìë™ ê°±ì‹ ',
    rangeLabel:'ê¸°ê°„ ì„ íƒ', rangeApply:'ì ìš©', rangeAll:'ì „ì²´',
    chartMainTga:'S&P 500 & TGA ì”ê³  â€” ì‹œê³„ì—´',
    chartMainFed:'S&P 500 & ê¸°ì¤€ê¸ˆë¦¬ â€” ì‹œê³„ì—´',
    chartCorr:'ë¡¤ë§ ìƒê´€ê³„ìˆ˜ (Pearson r)',
    chartScatterTga:'TGA ì”ê³  vs S&P 500 â€” ì‚°ì ë„ (ì„ íƒ êµ¬ê°„)',
    chartScatterFed:'ê¸°ì¤€ê¸ˆë¦¬ vs S&P 500 â€” ì‚°ì ë„ (ì„ íƒ êµ¬ê°„)',
    footerData:'ë°ì´í„°', footerSource:'ì†ŒìŠ¤ ì½”ë“œ',
    loadingText:'ë°ì´í„° ë¡œë”© ì¤‘â€¦',
    trendline:'ì¶”ì„¸ì„ ', overallR:'ì „ì²´ r', rollingR:'ë¡¤ë§ r',
    sp500Label:'S&P 500', tgaLabel:'TGA ì”ê³  (B$)', fedLabel:'ê¸°ì¤€ê¸ˆë¦¬ (%)',
  },
  en: {
    sidebarTitle:'Macro Analytics', navSection:'Market Indicators',
    navTga:'TGA vs S&P 500', navFed:'Fed Rate vs S&P 500',
    sidebarFooter:'Auto-updated every business day',
    viewTitleTga:'US Treasury TGA Balance & S&P 500',
    viewSubTga:'Auto-updated every business day Â· US Treasury Fiscal Data',
    viewTitleFed:'US Fed Funds Rate (FEDFUNDS) & S&P 500',
    viewSubFed:'Monthly update Â· FRED (Federal Reserve Economic Data)',
    statX:'TGA Balance', statXSub:'Billion USD (B$)',
    statXFed:'Fed Funds Rate', statXSubFed:'%',
    statSp500:'S&P 500', statSp500Sub:'Latest close',
    statCorr:'Overall Pearson r', statRangeCorr:'Range Pearson r',
    statRangeCorrSub:'Current selection', statUpdated:'Last Updated', statUpdatedSub:'Auto-updated',
    rangeLabel:'Time Range', rangeApply:'Apply', rangeAll:'All',
    chartMainTga:'S&P 500 & TGA Balance â€” Time Series',
    chartMainFed:'S&P 500 & Fed Rate â€” Time Series',
    chartCorr:'Rolling Correlation (Pearson r)',
    chartScatterTga:'TGA Balance vs S&P 500 â€” Scatter (selected range)',
    chartScatterFed:'Fed Rate vs S&P 500 â€” Scatter (selected range)',
    footerData:'Data', footerSource:'Source Code',
    loadingText:'Loading dataâ€¦',
    trendline:'Trendline', overallR:'Overall r', rollingR:'Rolling r',
    sp500Label:'S&P 500', tgaLabel:'TGA Balance (B$)', fedLabel:'Fed Rate (%)',
  },
  zh: {
    sidebarTitle:'å®è§‚åˆ†æ', navSection:'å¸‚åœºæŒ‡æ ‡',
    navTga:'TGA vs æ ‡æ™®500', navFed:'è”é‚¦åŸºå‡†åˆ©ç‡ vs æ ‡æ™®500',
    sidebarFooter:'æ¯ä¸ªäº¤æ˜“æ—¥è‡ªåŠ¨æ›´æ–°',
    viewTitleTga:'ç¾å›½è´¢æ”¿éƒ¨TGAä½™é¢ & æ ‡æ™®500',
    viewSubTga:'æ¯ä¸ªäº¤æ˜“æ—¥è‡ªåŠ¨æ›´æ–° Â· ç¾å›½è´¢æ”¿æ•°æ®',
    viewTitleFed:'ç¾å›½è”é‚¦åŸºå‡†åˆ©ç‡(FEDFUNDS) & æ ‡æ™®500',
    viewSubFed:'æ¯æœˆæ›´æ–° Â· FRED(ç¾è”å‚¨ç»æµæ•°æ®)',
    statX:'TGAä½™é¢', statXSub:'åäº¿ç¾å…ƒ (B$)',
    statXFed:'å½“å‰åŸºå‡†åˆ©ç‡', statXSubFed:'%',
    statSp500:'æ ‡æ™®500', statSp500Sub:'æœ€æ–°æ”¶ç›˜ä»·',
    statCorr:'æ€»ä½“Pearson r', statRangeCorr:'åŒºé—´Pearson r',
    statRangeCorrSub:'å½“å‰é€‰æ‹©åŒºé—´', statUpdated:'æœ€åæ›´æ–°', statUpdatedSub:'è‡ªåŠ¨æ›´æ–°',
    rangeLabel:'æ—¶é—´èŒƒå›´', rangeApply:'åº”ç”¨', rangeAll:'å…¨éƒ¨',
    chartMainTga:'æ ‡æ™®500 & TGAä½™é¢ â€” æ—¶é—´åºåˆ—',
    chartMainFed:'æ ‡æ™®500 & åŸºå‡†åˆ©ç‡ â€” æ—¶é—´åºåˆ—',
    chartCorr:'æ»šåŠ¨ç›¸å…³ç³»æ•° (Pearson r)',
    chartScatterTga:'TGAä½™é¢ vs æ ‡æ™®500 â€” æ•£ç‚¹å›¾ (é€‰å®šåŒºé—´)',
    chartScatterFed:'åŸºå‡†åˆ©ç‡ vs æ ‡æ™®500 â€” æ•£ç‚¹å›¾ (é€‰å®šåŒºé—´)',
    footerData:'æ•°æ®æ¥æº', footerSource:'æºä»£ç ',
    loadingText:'æ•°æ®åŠ è½½ä¸­â€¦',
    trendline:'è¶‹åŠ¿çº¿', overallR:'æ€»ä½“r', rollingR:'æ»šåŠ¨r',
    sp500Label:'æ ‡æ™®500', tgaLabel:'TGAä½™é¢ (B$)', fedLabel:'åŸºå‡†åˆ©ç‡ (%)',
  },
  ja: {
    sidebarTitle:'ãƒã‚¯ãƒ­åˆ†æ', navSection:'å¸‚å ´æŒ‡æ¨™',
    navTga:'TGA vs S&P500', navFed:'æ”¿ç­–é‡‘åˆ© vs S&P500',
    sidebarFooter:'æ¯å–¶æ¥­æ—¥è‡ªå‹•æ›´æ–°',
    viewTitleTga:'ç±³è²¡å‹™çœTGAæ®‹é«˜ & S&P500',
    viewSubTga:'æ¯å–¶æ¥­æ—¥è‡ªå‹•æ›´æ–° Â· ç±³è²¡å‹™çœè²¡æ”¿ãƒ‡ãƒ¼ã‚¿',
    viewTitleFed:'ç±³å›½æ”¿ç­–é‡‘åˆ©(FEDFUNDS) & S&P500',
    viewSubFed:'æ¯æœˆæ›´æ–° Â· FREDï¼ˆé€£é‚¦æº–å‚™åˆ¶åº¦çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ï¼‰',
    statX:'TGAæ®‹é«˜', statXSub:'åå„„ãƒ‰ãƒ« (B$)',
    statXFed:'ç¾åœ¨ã®æ”¿ç­–é‡‘åˆ©', statXSubFed:'%',
    statSp500:'S&P500', statSp500Sub:'æœ€æ–°çµ‚å€¤',
    statCorr:'å…¨ä½“Pearson r', statRangeCorr:'æœŸé–“Pearson r',
    statRangeCorrSub:'ç¾åœ¨ã®é¸æŠæœŸé–“', statUpdated:'æœ€çµ‚æ›´æ–°', statUpdatedSub:'è‡ªå‹•æ›´æ–°',
    rangeLabel:'æœŸé–“é¸æŠ', rangeApply:'é©ç”¨', rangeAll:'å…¨æœŸé–“',
    chartMainTga:'S&P500 & TGAæ®‹é«˜ â€” æ™‚ç³»åˆ—',
    chartMainFed:'S&P500 & æ”¿ç­–é‡‘åˆ© â€” æ™‚ç³»åˆ—',
    chartCorr:'ãƒ­ãƒ¼ãƒªãƒ³ã‚°ç›¸é–¢ä¿‚æ•° (Pearson r)',
    chartScatterTga:'TGAæ®‹é«˜ vs S&P500 â€” æ•£å¸ƒå›³ (é¸æŠæœŸé–“)',
    chartScatterFed:'æ”¿ç­–é‡‘åˆ© vs S&P500 â€” æ•£å¸ƒå›³ (é¸æŠæœŸé–“)',
    footerData:'ãƒ‡ãƒ¼ã‚¿', footerSource:'ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰',
    loadingText:'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦',
    trendline:'ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³', overallR:'å…¨ä½“r', rollingR:'ãƒ­ãƒ¼ãƒªãƒ³ã‚°r',
    sp500Label:'S&P500', tgaLabel:'TGAæ®‹é«˜ (B$)', fedLabel:'æ”¿ç­–é‡‘åˆ© (%)',
  },
};

let LANG = 'ko';

function t(key) { return T[LANG][key] ?? T['ko'][key] ?? key; }

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    el.textContent = t(key);
  });
  document.querySelectorAll('[data-i18n-inner]').forEach(el => {
    el.textContent = t(el.dataset.i18nInner);
  });
  document.getElementById('loading-text').textContent = t('loadingText');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Plotly ê³µí†µ ì„¤ì •
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BG      = '#0d1117';
const SURFACE = '#161b22';
const GREEN   = '#00E676';
const BLUE    = '#40C4FF';
const GOLD    = '#FFD700';
const ORANGE  = '#FF9800';
const RED     = '#FF5252';
const GRAY    = '#90A4AE';

const baseLayout = {
  paper_bgcolor: SURFACE, plot_bgcolor: BG,
  font: { color: GRAY, family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif', size: 11 },
  margin: { l: 62, r: 62, t: 14, b: 38 },
  xaxis: { gridcolor:'#1e2933', linecolor:'#263238', tickcolor: GRAY, rangeslider:{visible:false} },
  yaxis: { gridcolor:'#1e2933', linecolor:'#263238', tickcolor: GRAY },
  legend: { bgcolor:'#1a1a2e88', bordercolor:'#21262d', borderwidth:1, font:{color:'#e6edf3'} },
  hovermode: 'x unified',
  hoverlabel: { bgcolor:'#1a1a2e', bordercolor:'#21262d', font:{color:'#e6edf3'} },
};
const cfg = { responsive:true, displayModeBar:true, displaylogo:false,
  modeBarButtonsToRemove:['lasso2d','select2d'] };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë·° ì •ì˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const VIEWS = {
  tga: {
    file: 'data.json',
    xKey: 'tga',
    xColor: GOLD,
    xInvert: false,
    xTickPrefix: '$', xTickSuffix: 'B', xTickFormat: ',.1f',
    hoverX: v => `$${v?.toFixed(1)}B`,
    scatterXFormat: v => `$${v?.toFixed(1)}B`,
    titleMain: () => t('chartMainTga'),
    titleScatter: () => t('chartScatterTga'),
    xAxisLabel: () => t('tgaLabel'),
    statLabel: () => t('statX'),
    statSub: () => t('statXSub'),
    statVal: (d) => `$${d?.toFixed(1)}B`,
  },
  fed: {
    file: 'fed_rate_data.json',
    xKey: 'fed_rate',
    xColor: ORANGE,
    xInvert: true,
    xTickPrefix: '', xTickSuffix: '%', xTickFormat: '.2f',
    hoverX: v => `${v?.toFixed(2)}%`,
    scatterXFormat: v => `${v?.toFixed(2)}%`,
    titleMain: () => t('chartMainFed'),
    titleScatter: () => t('chartScatterFed'),
    xAxisLabel: () => t('fedLabel'),
    statLabel: () => t('statXFed'),
    statSub: () => t('statXSubFed'),
    statVal: (d) => `${d?.toFixed(2)}%`,
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentView = 'tga';
let cache       = {};      // { tga: {...}, fed: {...} }
let rangeFrom   = null;
let rangeTo     = null;
let RAW         = null;    // í˜„ì¬ ë·° ë°ì´í„°

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í—¬í¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pearsonR(xs, ys) {
  const n = xs.length; if (n < 2) return NaN;
  const mx = xs.reduce((a,b)=>a+b,0)/n, my = ys.reduce((a,b)=>a+b,0)/n;
  let num=0,dx2=0,dy2=0;
  for(let i=0;i<n;i++){const dx=xs[i]-mx,dy=ys[i]-my;num+=dx*dy;dx2+=dx*dx;dy2+=dy*dy;}
  return num/Math.sqrt(dx2*dy2);
}

function sliceByRange() {
  const dates = RAW.dates;
  let i0=0, i1=dates.length-1;
  if(rangeFrom){ while(i0<dates.length && dates[i0]<rangeFrom) i0++; }
  if(rangeTo)  { while(i1>0 && dates[i1]>rangeTo) i1--; }
  return [i0, i1];
}

function getSlice() {
  const [i0,i1] = sliceByRange();
  const vDef    = VIEWS[currentView];
  return {
    dates:        RAW.dates.slice(i0,i1+1),
    x:            RAW[vDef.xKey].slice(i0,i1+1),
    sp500:        RAW.sp500.slice(i0,i1+1),
    rolling_corr: RAW.rolling_corr.slice(i0,i1+1),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì°¨íŠ¸ 1 â€” ì´ì¤‘ ì¶• ì‹œê³„ì—´
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMain(slice) {
  const vDef = VIEWS[currentView];
  const traces = [
    {
      x: slice.dates, y: slice.sp500,
      name: t('sp500Label'), type:'scatter', mode:'lines',
      line:{color:GREEN,width:1.8}, yaxis:'y',
      hovertemplate:`<b>${t('sp500Label')}</b>: %{y:,.0f}<extra></extra>`,
    },
    {
      x: slice.dates, y: slice.x,
      name: vDef.xAxisLabel(), type:'scatter', mode:'lines',
      line:{color:vDef.xColor,width:1.5},
      fill:'tozeroy', fillcolor: vDef.xColor+'22',
      yaxis:'y2',
      hovertemplate:`<b>${vDef.xAxisLabel()}</b>: ${vDef.hoverX(0).replace('0','%{y:.4g}')}<extra></extra>`,
    },
  ];
  const y2 = {
    gridcolor:'#1e2933', showgrid:false, linecolor:'#263238', tickcolor:GRAY,
    title:{text: vDef.xAxisLabel(), font:{color:vDef.xColor}},
    tickprefix: vDef.xTickPrefix, ticksuffix: vDef.xTickSuffix,
    tickformat: vDef.xTickFormat,
    tickfont:{color:vDef.xColor}, overlaying:'y', side:'right',
    autorange: vDef.xInvert ? 'reversed' : true,
  };
  const layout = {
    ...baseLayout,
    height: 360,
    margin:{l:70,r:80,t:14,b:38},
    yaxis:{...baseLayout.yaxis, title:{text:t('sp500Label'),font:{color:GREEN}},
      tickformat:',.0f', tickfont:{color:GREEN}},
    yaxis2: y2,
    xaxis:{
      ...baseLayout.xaxis,
      range:[rangeFrom||RAW.dates[0], rangeTo||RAW.dates[RAW.dates.length-1]],
      rangeslider:{visible:true, bgcolor:'#1e2933', bordercolor:'#21262d', thickness:0.06},
      rangeselector:{
        bgcolor:SURFACE, bordercolor:'#21262d', borderwidth:1, font:{color:GRAY},
        buttons:[
          {count:3,step:'month',stepmode:'backward',label:'3M'},
          {count:6,step:'month',stepmode:'backward',label:'6M'},
          {count:1,step:'year', stepmode:'backward',label:'1Y'},
          {count:2,step:'year', stepmode:'backward',label:'2Y'},
          {step:'all',label: t('rangeAll')},
        ],
      },
    },
  };
  Plotly.react('chart-main', traces, layout, cfg);

  document.getElementById('chart-main').on('plotly_relayout', (e) => {
    const from = e['xaxis.range[0]'] || (e['xaxis.range']&&e['xaxis.range'][0]);
    const to   = e['xaxis.range[1]'] || (e['xaxis.range']&&e['xaxis.range'][1]);
    if (from && to) {
      rangeFrom = from.substring(0,10); rangeTo = to.substring(0,10);
      document.getElementById('date-from').value = rangeFrom;
      document.getElementById('date-to').value   = rangeTo;
      syncSecondary();
    }
    if (e['xaxis.autorange']) {
      rangeFrom = RAW.dates[0]; rangeTo = RAW.dates[RAW.dates.length-1];
      document.getElementById('date-from').value = rangeFrom;
      document.getElementById('date-to').value   = rangeTo;
      syncSecondary();
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì°¨íŠ¸ 2 â€” ë¡¤ë§ ìƒê´€ê³„ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawCorr(slice) {
  const colors = slice.rolling_corr.map(v => v==null ? GRAY : v>=0 ? GREEN : RED);
  const traces = [
    {
      x:slice.dates, y:slice.rolling_corr,
      name: t('rollingR'), type:'bar',
      marker:{color:colors, opacity:0.75},
      hovertemplate:`<b>${t('rollingR')}</b>: %{y:.3f}<extra></extra>`,
    },
    {
      x:[slice.dates[0], slice.dates[slice.dates.length-1]],
      y:[RAW.corr, RAW.corr],
      name:`${t('overallR')} = ${RAW.corr}`,
      type:'scatter', mode:'lines',
      line:{color:BLUE,width:1.5,dash:'dash'}, hoverinfo:'skip',
    },
  ];
  const layout = {
    ...baseLayout, height:220, bargap:0.08,
    yaxis:{...baseLayout.yaxis, range:[-1.05,1.05], tickformat:'.2f',
      title:{text:'Pearson r',font:{color:GRAY}}},
    xaxis:{...baseLayout.xaxis,
      range:[rangeFrom||RAW.dates[0], rangeTo||RAW.dates[RAW.dates.length-1]]},
  };
  Plotly.react('chart-corr', traces, layout, cfg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì°¨íŠ¸ 3 â€” ì‚°ì ë„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawScatter(slice) {
  const vDef  = VIEWS[currentView];
  const years = [...new Set(slice.dates.map(d=>d.substring(0,4)))].sort();
  const pal   = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#845EC2','#FF9671','#00C9A7','#F9C74F'];
  const yc    = {}; years.forEach((y,i)=>yc[y]=pal[i%pal.length]);

  const byYear = {};
  slice.dates.forEach((d,i)=>{
    const y=d.substring(0,4);
    if(!byYear[y]) byYear[y]={x:[],y:[]};
    if(slice.x[i]!=null && slice.sp500[i]!=null){byYear[y].x.push(slice.x[i]);byYear[y].y.push(slice.sp500[i]);}
  });

  const allX=[], allY=[];
  Object.values(byYear).forEach(g=>{allX.push(...g.x);allY.push(...g.y);});
  const r = pearsonR(allX, allY);
  document.getElementById('stat-range-corr').textContent = isNaN(r)?'â€”':r.toFixed(3);

  // ì¶”ì„¸ì„ 
  const n=allX.length; let sumX=0,sumY=0,sumXY=0,sumX2=0;
  for(let i=0;i<n;i++){sumX+=allX[i];sumY+=allY[i];sumXY+=allX[i]*allY[i];sumX2+=allX[i]*allX[i];}
  const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
  const intercept=(sumY-slope*sumX)/n;
  const xMin=Math.min(...allX), xMax=Math.max(...allX);
  const trendX=[xMin,xMax], trendY=trendX.map(x=>slope*x+intercept);

  const traces = Object.entries(byYear).map(([y,g])=>({
    x:g.x, y:g.y, name:y, type:'scatter', mode:'markers',
    marker:{color:yc[y],size:5,opacity:0.65},
    hovertemplate:`<b>${y}</b><br>${vDef.xAxisLabel()}: ${vDef.scatterXFormat(0).replace('0','%{x:.3g}')}<br>S&P: %{y:,.0f}<extra></extra>`,
  }));
  traces.push({
    x:trendX, y:trendY,
    name:`${t('trendline')} r=${isNaN(r)?'â€”':r.toFixed(3)}`,
    type:'scatter', mode:'lines',
    line:{color:BLUE,width:2,dash:'dash'}, hoverinfo:'skip',
  });

  const layout = {
    ...baseLayout, height:300,
    xaxis:{...baseLayout.xaxis, rangeslider:{visible:false},
      title:{text:vDef.xAxisLabel(),font:{color:GRAY}},
      tickprefix:vDef.xTickPrefix, ticksuffix:vDef.xTickSuffix, tickformat:vDef.xTickFormat},
    yaxis:{...baseLayout.yaxis, title:{text:t('sp500Label'),font:{color:GRAY}}, tickformat:',.0f'},
    legend:{...baseLayout.legend, orientation:'h', y:-0.18, x:0},
  };
  Plotly.react('chart-scatter', traces, layout, cfg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í†µê³„ ì¹´ë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const vDef = VIEWS[currentView];
  const last = RAW.dates.length-1;
  const xLast = RAW[vDef.xKey][last];
  document.getElementById('stat-x').textContent      = vDef.statVal(xLast);
  document.getElementById('stat-x-label').textContent= vDef.statLabel();
  document.getElementById('stat-x-sub').textContent  = vDef.statSub();
  document.getElementById('stat-sp500').textContent  = RAW.sp500[last]?.toLocaleString('ko-KR',{maximumFractionDigits:0}) ?? 'â€”';
  document.getElementById('stat-corr').textContent   = RAW.corr;
  document.getElementById('stat-pval').textContent   = `p ${RAW.pval<0.001?'< 0.001':'= '+RAW.pval}`;
  document.getElementById('stat-updated').textContent= RAW.updated;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í—¤ë” & ì°¨íŠ¸ íƒ€ì´í‹€ ê°±ì‹ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateViewText() {
  const vDef = VIEWS[currentView];
  const isTga = currentView === 'tga';
  document.getElementById('view-title').textContent = t(isTga?'viewTitleTga':'viewTitleFed');
  document.getElementById('view-sub').textContent   = t(isTga?'viewSubTga':'viewSubFed');
  document.getElementById('title-main').textContent    = vDef.titleMain();
  document.getElementById('title-scatter').textContent = vDef.titleScatter();
  document.getElementById('title-corr').textContent    = t('chartCorr');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë™ê¸°í™” (range ë³€ê²½ ì‹œ corr + scatterë§Œ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncSecondary() {
  const slice = getSlice();
  drawCorr(slice);
  drawScatter(slice);
}

function renderAll() {
  const slice = getSlice();
  updateStats();
  updateViewText();
  drawMain(slice);
  drawCorr(slice);
  drawScatter(slice);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë·° ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function switchView(viewId) {
  if (viewId === currentView && RAW) return;
  currentView = viewId;

  // nav active state
  document.querySelectorAll('.nav-item').forEach(b=>{
    b.classList.toggle('active', b.dataset.view === viewId);
  });

  // ìºì‹œì— ìˆìœ¼ë©´ ë°”ë¡œ ë Œë”
  if (cache[viewId]) {
    RAW = cache[viewId];
    rangeFrom = RAW.dates[0];
    rangeTo   = RAW.dates[RAW.dates.length-1];
    document.getElementById('date-from').value = rangeFrom;
    document.getElementById('date-to').value   = rangeTo;
    document.querySelectorAll('.rng-btn').forEach(b=>b.classList.toggle('active', b.dataset.months==='0'));
    renderAll();
    return;
  }

  // ë¡œë”©
  document.getElementById('chart-main').innerHTML    = '<div style="height:360px;display:flex;align-items:center;justify-content:center;color:var(--muted)"><div class="spinner"></div></div>';
  document.getElementById('chart-corr').innerHTML    = '';
  document.getElementById('chart-scatter').innerHTML = '';

  try {
    const res = await fetch(VIEWS[viewId].file);
    if (!res.ok) throw new Error(res.statusText);
    RAW = await res.json();
    cache[viewId] = RAW;
    rangeFrom = RAW.dates[0];
    rangeTo   = RAW.dates[RAW.dates.length-1];
    document.getElementById('date-from').value = rangeFrom;
    document.getElementById('date-to').value   = rangeTo;
    document.querySelectorAll('.rng-btn').forEach(b=>b.classList.toggle('active',b.dataset.months==='0'));
    renderAll();
  } catch(err) {
    document.getElementById('chart-main').innerHTML =
      `<div style="padding:2rem;color:var(--red)">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë²”ìœ„ ë²„íŠ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyMonths(months) {
  const last = new Date(RAW.dates[RAW.dates.length-1]);
  if (months===0) {
    rangeFrom=RAW.dates[0]; rangeTo=RAW.dates[RAW.dates.length-1];
  } else {
    const from=new Date(last); from.setMonth(from.getMonth()-months);
    rangeFrom=from.toISOString().substring(0,10); rangeTo=RAW.dates[RAW.dates.length-1];
  }
  document.getElementById('date-from').value=rangeFrom;
  document.getElementById('date-to').value=rangeTo;
  Plotly.relayout('chart-main',{'xaxis.range':[rangeFrom,rangeTo]});
  syncSecondary();
}

document.getElementById('range-btns').addEventListener('click', e=>{
  const btn=e.target.closest('.rng-btn'); if(!btn) return;
  document.querySelectorAll('.rng-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  applyMonths(Number(btn.dataset.months));
});

document.getElementById('apply-range').addEventListener('click', ()=>{
  rangeFrom=document.getElementById('date-from').value;
  rangeTo=document.getElementById('date-to').value;
  if(!rangeFrom||!rangeTo) return;
  document.querySelectorAll('.rng-btn').forEach(b=>b.classList.remove('active'));
  Plotly.relayout('chart-main',{'xaxis.range':[rangeFrom,rangeTo]});
  syncSecondary();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‚¬ì´ë“œë°” í† ê¸€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sidebar  = document.getElementById('sidebar');
const mainEl   = document.getElementById('main');
const overlay  = document.getElementById('overlay');
let sidebarOpen = true;

function toggleSidebar() {
  const isMobile = window.innerWidth <= 768;
  if (isMobile) {
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show', sidebar.classList.contains('open'));
  } else {
    sidebarOpen = !sidebarOpen;
    sidebar.classList.toggle('collapsed', !sidebarOpen);
    mainEl.classList.toggle('full', !sidebarOpen);
    mainEl.style.marginLeft = sidebarOpen
      ? 'var(--sidebar-w)'
      : '0';
    // resize charts after transition
    setTimeout(()=>{ Plotly.Plots.resize('chart-main'); Plotly.Plots.resize('chart-corr'); Plotly.Plots.resize('chart-scatter'); }, 280);
  }
}

document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
overlay.addEventListener('click', ()=>{ sidebar.classList.remove('open'); overlay.classList.remove('show'); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë„¤ë¹„ê²Œì´ì…˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.nav-item').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    switchView(btn.dataset.view);
    // mobile: close sidebar
    if(window.innerWidth<=768){ sidebar.classList.remove('open'); overlay.classList.remove('show'); }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì–¸ì–´ ì „í™˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.lang-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    LANG = btn.dataset.lang;
    document.documentElement.lang = LANG === 'zh' ? 'zh-CN' : LANG === 'ja' ? 'ja' : LANG;
    document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active', b===btn));
    applyTranslations();
    updateViewText();
    // ì°¨íŠ¸ ì¬ë Œë” (ë¼ë²¨ ê°±ì‹ )
    if (RAW) renderAll();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  applyTranslations();
  await switchView('tga');
  document.getElementById('loading').style.display = 'none';
}

init().catch(err=>{
  document.getElementById('loading').innerHTML=
    `<span style="color:var(--red)">ì´ˆê¸°í™” ì‹¤íŒ¨: ${err.message}</span>`;
});
</script>
</body>
</html>
